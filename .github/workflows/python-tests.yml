# GitHub Actions Workflow for Python Tests
# This workflow runs unit tests, integration tests, and coverage reports
# Triggered by: push, pull_request, and /test command via PR comments
name: Python Tests

on:
  push:
    branches:
      - main
      - dev
    paths:
      - "**.py"
      - ".github/workflows/python-tests.yml"
      - "requirements*.txt"
      - "setup.py"
      - "pyproject.toml"
      - "tests/**"
  pull_request:
    branches:
      - main
      - dev
    paths:
      - "**.py"
      - ".github/workflows/python-tests.yml"
      - "requirements*.txt"
      - "setup.py"
      - "pyproject.toml"
      - "tests/**"
  issue_comment:
    types: [created]

jobs:
  # Check if the comment is a /test or /retest command
  check-comment:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request
    runs-on: ubuntu-latest
    outputs:
      triggered: ${{ steps.check.outputs.triggered }}
      test_type: ${{ steps.check.outputs.test_type }}
    steps:
      - name: Check for test commands
        id: check
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if [[ "$COMMENT" =~ ^/test || "$COMMENT" =~ ^/retest ]]; then
            echo "triggered=true" >> $GITHUB_OUTPUT

            # Determine test type
            if [[ "$COMMENT" =~ /test[[:space:]]+all ]]; then
              echo "test_type=all" >> $GITHUB_OUTPUT
            elif [[ "$COMMENT" =~ /test[[:space:]]+integration ]]; then
              echo "test_type=integration" >> $GITHUB_OUTPUT
            elif [[ "$COMMENT" =~ /test[[:space:]]+unit ]]; then
              echo "test_type=unit" >> $GITHUB_OUTPUT
            elif [[ "$COMMENT" =~ /test[[:space:]]+db ]]; then
              echo "test_type=db" >> $GITHUB_OUTPUT
            else
              echo "test_type=default" >> $GITHUB_OUTPUT
            fi
          else
            echo "triggered=false" >> $GITHUB_OUTPUT
            echo "test_type=none" >> $GITHUB_OUTPUT
          fi

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'issue_comment' ||
      (github.event_name == 'issue_comment' && needs.check-comment.outputs.triggered == 'true')
    needs: [check-comment]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]
        os: [ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock pytest-asyncio pytest-xdist
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi
          if [ -f requirements-test.txt ]; then
            pip install -r requirements-test.txt
          fi

      - name: Run unit tests with coverage
        run: |
          echo "::group::Running Unit Tests"
          if [ -d tests ]; then
            pytest tests/ \
              --cov=. \
              --cov-report=term-missing \
              --cov-report=xml \
              --cov-report=html \
              --junitxml=junit/test-results-${{ matrix.python-version }}.xml \
              -v \
              --tb=short \
              -n auto
          else
            echo "No tests directory found. Skipping tests."
            mkdir -p tests
            echo "def test_placeholder():\n    assert True" > tests/test_placeholder.py
            pytest tests/test_placeholder.py -v
          fi
          echo "::endgroup::"

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            junit/test-results-*.xml
            htmlcov/
            coverage.xml
          retention-days: 7

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: junit/test-results-*.xml
          check_name: Test Results (Python ${{ matrix.python-version }})

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: |
      (github.event_name != 'issue_comment') ||
      (github.event_name == 'issue_comment' && needs.check-comment.outputs.triggered == 'true' &&
       (needs.check-comment.outputs.test_type == 'integration' || needs.check-comment.outputs.test_type == 'all'))
    needs: [check-comment]
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pymongo
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi

      - name: Wait for MongoDB
        run: |
          until mongosh --host localhost:27017 -u test -p test --eval "db.runCommand({ ping: 1 })" > /dev/null 2>&1; do
            echo "Waiting for MongoDB..."
            sleep 2
          done
          echo "MongoDB is ready!"

      - name: Run integration tests
        env:
          MONGODB_URI: mongodb://test:test@localhost:27017/
          TEST_DATABASE: bhv_test
        run: |
          echo "::group::Running Integration Tests"
          if [ -d tests/integration ]; then
            pytest tests/integration/ -v --tb=short
          else
            echo "No integration tests found. Skipping."
          fi
          echo "::endgroup::"

  database-tests:
    name: Database Tests
    runs-on: ubuntu-latest
    if: |
      (github.event_name != 'issue_comment') ||
      (github.event_name == 'issue_comment' && needs.check-comment.outputs.triggered == 'true' &&
       (needs.check-comment.outputs.test_type == 'db' || needs.check-comment.outputs.test_type == 'all'))
    needs: [check-comment]
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pymongo
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run database tests
        env:
          MONGODB_URI: mongodb://test:test@localhost:27017/
          TEST_DATABASE: bhv_test_db
        run: |
          echo "::group::Running Database Tests"
          if [ -d tests/database ]; then
            pytest tests/database/ -v --tb=short
          else
            echo "No database tests found. Skipping."
          fi
          echo "::endgroup::"

  comment-result:
    name: Comment Test Results
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && always()
    needs: [check-comment, unit-tests, integration-tests, database-tests]
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const unitTests = '${{ needs.unit-tests.result }}';
            const integrationTests = '${{ needs.integration-tests.result }}';
            const databaseTests = '${{ needs.database-tests.result }}';
            const testType = '${{ needs.check-comment.outputs.test_type }}';

            let message = '### Test Results\n\n';

            if (unitTests !== 'skipped') {
              const icon = unitTests === 'success' ? '[PASS]' : '[FAIL]';
              message += `${icon} **Unit Tests**: ${unitTests}\n`;
            }

            if (integrationTests !== 'skipped') {
              const icon = integrationTests === 'success' ? '[PASS]' : '[FAIL]';
              message += `${icon} **Integration Tests**: ${integrationTests}\n`;
            }

            if (databaseTests !== 'skipped') {
              const icon = databaseTests === 'success' ? '[PASS]' : '[FAIL]';
              message += `${icon} **Database Tests**: ${databaseTests}\n`;
            }

            message += '\n[View detailed results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
