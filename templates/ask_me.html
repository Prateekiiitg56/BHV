{% extends 'base.html' %}
{% block title %}Ask Me â€” Behavioral Health Vault{% endblock %}
{% block content %}
<section class="section">
  <div class="container" style="max-width:720px">
    <div class="section-header">
      <span class="section-label">AI Assistant</span>
      <h2 class="section-title">Ask Me</h2>
      <p class="section-subtitle">
        Search your records by keyword, count uploads, or explore your recovery timeline.
      </p>
    </div>

    <div class="card">
      <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <label for="question">Your Question</label>
        <textarea id="question" name="question" rows="3"
          placeholder="e.g., 'What were the main topics of my latest entries?' or 'How many active journeys do I have?'"
          required>{{ question or '' }}</textarea>
        <div class="btn-group" style="margin-top: 1rem;">
          <button class="btn btn-primary" style="box-shadow: var(--shadow-sm);" type="submit">Ask Assistant</button>
          <a class="btn btn-secondary" href="{{ url_for('upload') }}">Create New Entry</a>
        </div>
      </form>
    </div>

    {% if answer %}
    <div class="ai-response"
      style="margin-top:2rem; padding: 2rem; background: var(--c-surface); border: 1px solid var(--c-border); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
      <h3
        style="display: flex; align-items: center; gap: 8px; font-family: var(--font-editorial); color: var(--c-primary-hover); margin-bottom: 1rem;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        Assistant's Response
      </h3>
      <div class="ai-response__body" style="font-size: 1.05rem; line-height: 1.7; color: var(--slate-800);">
        {{ answer | replace('\n', '<br>') | safe }}
      </div>

      {% if results %}
      <h4 style="margin-top:1.25rem">Related Records</h4>
      {% for entry in results %}
      <div class="ai-result-item">
        <strong>{{ entry.filename }}</strong>
        <div class="muted">{{ entry.timestamp }}</div>
        {% if entry.narrative %}
        <div style="margin-top:.375rem;font-style:italic;color:var(--slate-400)">"{{ entry.narrative }}"</div>
        {% endif %}
        <a href="{{ url_for('file_version', patient_id=entry.patient_id, filename=entry.filename) }}" class="btn btn-sm"
          style="margin-top:.5rem">
          View Record
        </a>
      </div>
      {% endfor %}
      {% endif %}
    </div>
    {% endif %}

    <div class="card"
      style="margin-top:2.5rem; background: var(--c-bg); border: 2px dashed var(--c-border); padding: 1.5rem;">
      <h4 style="font-family: var(--font-editorial); margin-bottom: 0.5rem; color: var(--slate-600);">Example Questions
      </h4>
      <ul
        style="color: var(--c-text-secondary); font-size: 0.95rem; line-height: 1.8; list-style-type: disc; margin-left: 1.5rem;">
        <li>"Summarize my journey based on my recent entries."</li>
        <li>"How many total timeline journeys and entries do I have?"</li>
        <li>"Are there any common themes in my mental health logs?"</li>
        <li>"What did I write about in my first ever entry?"</li>
      </ul>
    </div>
  </div>
</section>
{% endblock %}